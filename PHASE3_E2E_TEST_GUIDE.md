# Phase 3: E2Eテストガイド

Phase 2の本番環境設定が完了したら、このガイドに従って全機能をテストします。

---

## 📋 テスト概要

### テスト目的
- 本番環境で全機能が正常に動作することを確認
- セキュリティ機能が正しく動作することを検証
- ユーザーエクスペリエンスを最終確認

### テスト環境
- URL: https://booking.furniturehouse1.com
- Firebase: 本番プロジェクト
- Stripe: 本番モード（実際のカード使用）

---

## 🧪 テストシナリオ

### 1. 予約作成フロー（E2Eテスト）

#### テストケース1-1: 通常の予約フロー

**目的:** 最も基本的な予約フローをテスト

**手順:**
```
1. トップページにアクセス
   https://booking.furniturehouse1.com

2. 日付を選択
   - チェックイン: 2週間後の金曜日
   - チェックアウト: 日曜日（2泊3日）
   - ゲスト数: 2名

3. 「予約リクエストへ」をクリック

4. ゲスト情報を入力
   - 名前: テスト 太郎
   - メール: your-test-email@example.com
   - 電話: 090-1234-5678
   - 備考: テスト予約です

5. カード情報を入力（実際のカード）
   ⚠️ 少額をテストするため、最短宿泊を推奨

6. 利用規約に同意

7. 「リクエストを送信」をクリック

8. 完了ページにリダイレクト
```

**期待結果:**
- ✅ 決済が成功
- ✅ 予約番号が表示される（例: FH1-XXXXX-YYYY）
- ✅ 完了ページに予約詳細が表示
- ✅ Firestoreに予約データが作成される
- ✅ Stripeダッシュボードに決済記録
- ✅ 確認メールが送信される（ゲストと管理者）

**確認項目:**
```bash
1. Firestoreコンソールで予約を確認
   - コレクション: bookings
   - ステータス: confirmed（Webhook後）
   - 金額: 正しく計算されているか

2. Stripeダッシュボードで決済を確認
   - 決済額が一致
   - メタデータに予約情報

3. メール受信を確認
   - 件名: 【予約確定】家具の家 No.1
   - 内容: 予約詳細が記載
```

---

#### テストケース1-2: クーポン適用

**前提条件:** Firestoreにテスト用クーポンを作成

**クーポン作成:**
```javascript
コレクション: coupons
ドキュメントID: 自動生成

フィールド:
{
  code: "TEST10",
  discountAmount: 1000,
  isActive: true,
  maxUses: 10,
  usedCount: 0,
  expiresAt: [1ヶ月後のタイムスタンプ],
  createdAt: [現在のタイムスタンプ]
}
```

**手順:**
```
1. 予約フローを開始

2. ゲスト情報入力画面で
   - クーポンコード: TEST10 を入力

3. 金額が割引されることを確認
   - 元の金額 - 1,000円

4. 決済を完了
```

**期待結果:**
- ✅ クーポンが適用される
- ✅ 割引後の金額で決済
- ✅ Firestoreのクーポン使用回数が増加

---

#### テストケース1-3: 同時予約の防止

**目的:** 同じ日程を2人が同時に予約できないことを確認

**手順:**
```
1. ブラウザAで予約フローを開始
   - 日付: 3週間後（金曜〜日曜）
   - ゲスト: 2名

2. ブラウザB（シークレットモード）でも同じ日程で開始

3. ブラウザAで決済を完了

4. ブラウザBで決済を試みる
```

**期待結果:**
- ✅ ブラウザAの予約は成功
- ✅ ブラウザBは「既に予約されています」エラー
- ✅ 重複予約が作成されない

---

#### テストケース1-4: 決済失敗時の処理

**目的:** カード決済が失敗した場合の処理を確認

**手順:**
```
1. 予約フローを開始

2. カード情報に不正なデータを入力
   - カード番号: 1111 1111 1111 1111
   または
   - セキュリティコード: 000

3. 「リクエストを送信」をクリック
```

**期待結果:**
- ✅ エラーメッセージが表示
- ✅ 予約データが作成されない（またはstatus=failed）
- ✅ ユーザーが再試行できる

---

### 2. レート制限テスト

#### テストケース2-1: API過剰リクエスト

**目的:** レート制限が機能することを確認

**手順:**
```
1. 短時間に同じAPIを連続で呼び出す
   例: 料金計算APIを10回連続

2. レート制限に達する
```

**期待結果:**
- ✅ 一定回数後に429エラー
- ✅ エラーメッセージ: 「リクエストが多すぎます」
- ✅ X-RateLimit-* ヘッダーが返却される

**確認コマンド（ローカルから）:**
```bash
for i in {1..10}; do
  curl -X POST https://booking.furniturehouse1.com/api/test/calculate-price \
    -H "Content-Type: application/json" \
    -d '{"checkInDate":"2025-02-01","checkOutDate":"2025-02-03","guestCount":2}'
  echo ""
  sleep 1
done
```

---

### 3. セキュリティテスト

#### テストケース3-1: セキュリティヘッダー

**目的:** セキュリティヘッダーが設定されていることを確認

**手順:**
```bash
curl -I https://booking.furniturehouse1.com/api/test/health
```

**期待結果:**
```http
x-xss-protection: 1; mode=block
x-content-type-options: nosniff
x-frame-options: DENY
content-security-policy: ...
```

**確認:**
- ✅ 全てのセキュリティヘッダーが設定されている

---

#### テストケース3-2: 金額改ざん防止

**目的:** クライアント側で金額を変更しても、サーバーで検証されることを確認

**手順:**
```
開発者ツールでネットワークリクエストを傍受し、
amountフィールドを不正な値に変更して送信

または

curlコマンドで不正な金額を送信:
curl -X POST https://booking.furniturehouse1.com/api/bookings/create-secure \
  -H "Content-Type: application/json" \
  -d '{
    "checkInDate":"2025-02-01",
    "checkOutDate":"2025-02-03",
    "guestCount":2,
    "guestName":"テスト",
    "guestEmail":"test@example.com",
    "guestPhone":"090-1234-5678",
    "amount":1000
  }'
```

**期待結果:**
- ✅ エラー: 「金額の検証に失敗しました」
- ✅ 予約が作成されない

---

### 4. Webhook処理テスト

#### テストケース4-1: 決済成功イベント

**目的:** Webhookが正しく処理されることを確認

**手順:**
```
1. 通常の予約を作成（決済完了）

2. Stripeダッシュボードでイベントを確認
   開発者 → イベント

3. payment_intent.succeeded イベントを確認

4. Firestoreで予約ステータスを確認
```

**期待結果:**
- ✅ Webhookイベントが送信される
- ✅ 予約ステータスが pending → confirmed に更新
- ✅ webhookLogs コレクションにログが記録される

---

#### テストケース4-2: 返金処理

**目的:** 返金が正しく処理されることを確認

**手順:**
```
1. テスト予約を作成

2. Stripeダッシュボードで返金を実行
   - 支払い → [予約を選択]
   - 「払い戻し」をクリック
   - 金額: 全額
   - 理由: テスト

3. Webhookイベントを確認

4. Firestoreで予約ステータスを確認
```

**期待結果:**
- ✅ charge.refunded イベントが送信される
- ✅ 予約ステータスが refunded に更新
- ✅ refundAmount が記録される

---

### 5. メール送信テスト

#### テストケース5-1: 予約確認メール

**手順:**
```
1. 予約を作成

2. メールボックスを確認
   - ゲスト用: 登録したメールアドレス
   - 管理者用: 設定したメールアドレス
```

**期待メール内容（ゲスト宛）:**
```
件名: 【予約確定】家具の家 No.1 ご予約確認

本文:
- 予約番号
- チェックイン/アウト日時
- ゲスト数
- 料金詳細
- アクセス情報
- 連絡先
```

**期待メール内容（管理者宛）:**
```
件名: 【新規予約】家具の家 No.1

本文:
- 予約番号
- ゲスト情報
- 宿泊日程
- 決済情報
- 管理リンク
```

**確認:**
- ✅ メールが届く
- ✅ 内容が正確
- ✅ リンクが機能する
- ✅ スパムに入らない

---

#### テストケース5-2: エラーメール送信失敗時

**目的:** メール送信失敗時にシステムがクラッシュしないことを確認

**手順:**
```
一時的にメール設定を無効化して予約を作成
```

**期待結果:**
- ✅ 予約は成功する
- ✅ メール送信エラーがログに記録される
- ✅ システムは継続動作する

---

### 6. パフォーマンステスト

#### テストケース6-1: ページ読み込み速度

**ツール:** Google Lighthouse

**手順:**
```
1. Chrome DevTools → Lighthouse

2. カテゴリを選択
   - Performance
   - Accessibility
   - Best Practices
   - SEO

3. 「Generate report」

4. 各ページでテスト
   - トップページ
   - 予約フォーム
   - 完了ページ
```

**目標スコア:**
- Performance: 90以上
- Accessibility: 90以上
- Best Practices: 95以上
- SEO: 90以上

---

#### テストケース6-2: API応答時間

**手順:**
```bash
# 料金計算API
time curl -X POST https://booking.furniturehouse1.com/api/test/calculate-price \
  -H "Content-Type: application/json" \
  -d '{"checkInDate":"2025-02-01","checkOutDate":"2025-02-03","guestCount":2}'

# Payment Intent作成
time curl -X POST https://booking.furniturehouse1.com/api/test/create-payment-intent-mock \
  -H "Content-Type: application/json" \
  -d '{"checkInDate":"2025-02-01","checkOutDate":"2025-02-03","guestCount":2}'
```

**目標:**
- 料金計算: < 500ms
- Payment Intent: < 2000ms

---

### 7. モバイルテスト

#### テストケース7-1: レスポンシブデザイン

**デバイス:**
- iPhone 14 Pro (Safari)
- Android (Chrome)
- iPad (Safari)

**確認項目:**
```
1. トップページ
   - [ ] レイアウトが崩れない
   - [ ] カレンダーが表示される
   - [ ] ボタンがタップしやすい

2. 予約フォーム
   - [ ] フォームが入力しやすい
   - [ ] キーボードでフィールドが隠れない
   - [ ] バリデーションメッセージが見える

3. 決済画面
   - [ ] Stripe Elementが表示される
   - [ ] カード入力が機能する
   - [ ] セキュリティ警告が出ない

4. 完了ページ
   - [ ] 予約詳細が見やすい
   - [ ] ボタンが機能する
```

---

## 📊 テスト結果記録シート

### 予約作成フロー

| テストケース | 実施日 | 結果 | 備考 |
|------------|--------|------|------|
| 1-1: 通常の予約フロー | __ / __ | ☐ | |
| 1-2: クーポン適用 | __ / __ | ☐ | |
| 1-3: 同時予約の防止 | __ / __ | ☐ | |
| 1-4: 決済失敗時の処理 | __ / __ | ☐ | |

### セキュリティ

| テストケース | 実施日 | 結果 | 備考 |
|------------|--------|------|------|
| 2-1: API過剰リクエスト | __ / __ | ☐ | |
| 3-1: セキュリティヘッダー | __ / __ | ☐ | |
| 3-2: 金額改ざん防止 | __ / __ | ☐ | |

### Webhook・メール

| テストケース | 実施日 | 結果 | 備考 |
|------------|--------|------|------|
| 4-1: 決済成功イベント | __ / __ | ☐ | |
| 4-2: 返金処理 | __ / __ | ☐ | |
| 5-1: 予約確認メール | __ / __ | ☐ | |
| 5-2: エラーメール送信失敗時 | __ / __ | ☐ | |

### パフォーマンス

| テストケース | 実施日 | スコア | 備考 |
|------------|--------|--------|------|
| 6-1: Lighthouse Performance | __ / __ | __ / 100 | |
| 6-1: Lighthouse Accessibility | __ / __ | __ / 100 | |
| 6-2: API応答時間 | __ / __ | __ ms | |

### モバイル

| デバイス | 実施日 | 結果 | 備考 |
|---------|--------|------|------|
| iPhone (Safari) | __ / __ | ☐ | |
| Android (Chrome) | __ / __ | ☐ | |
| iPad (Safari) | __ / __ | ☐ | |

---

## ✅ 最終チェックリスト

### 本番運用開始前

- [ ] 全てのE2Eテストが成功
- [ ] セキュリティテストが成功
- [ ] メール送信が正常動作
- [ ] Webhookが正常動作
- [ ] モバイルで問題なし
- [ ] パフォーマンススコア目標達成
- [ ] 管理者ダッシュボードアクセス確認
- [ ] バックアップ設定完了
- [ ] 監視ツール設定完了
- [ ] 運用マニュアル確認
- [ ] 緊急連絡先リスト作成
- [ ] ステークホルダー承認取得

---

## 🐛 不具合発見時の対応

### 重要度: Critical（運用停止レベル）

**例:** 決済が完了しない、データが保存されない

**対応:**
1. 即座に開発者に連絡
2. 必要に応じてロールバック
3. 原因究明と修正
4. 再テスト

### 重要度: High（早急に修正）

**例:** メールが届かない、一部機能が動作しない

**対応:**
1. 問題をログに記録
2. 回避策を検討
3. 24時間以内に修正
4. 修正後に再テスト

### 重要度: Medium（計画的に修正）

**例:** UIの不具合、パフォーマンス低下

**対応:**
1. バックログに登録
2. 次回リリースで修正
3. ユーザーへの影響を最小化

---

## 🎯 テスト完了後のアクション

### 全テスト成功の場合

1. **最終レビュー**
   - ステークホルダーへのデモ
   - 運用チームへの説明

2. **本番運用開始**
   - 告知ページ公開
   - SNS・メールでアナウンス

3. **モニタリング開始**
   - 1日目: 1時間ごとに確認
   - 1週間: 1日1回確認
   - 以降: 週1回確認

### 不具合発見の場合

1. **原因分析**
   - ログの確認
   - 再現手順の記録

2. **修正実施**
   - 開発環境で修正
   - テスト環境で検証
   - 本番環境にデプロイ

3. **再テスト**
   - 全テストを再実施

---

**Phase 3完了後、本番運用を開始できます！**

**作成日: 2025-12-30**
**対象: 本番環境テスト**
