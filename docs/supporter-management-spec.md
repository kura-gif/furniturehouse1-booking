# サポーター管理機能 仕様書

## 概要

「家具の家 No.1」の清掃・メンテナンス業務を担当するサポーターを管理する機能です。
管理者がサポーターを登録・編集・有効/無効化できます。

---

## データ構造

サポーターの情報は **2つのコレクション** に分けて保存されます。

### 1. `users` コレクション（認証・基本情報）

すべてのユーザー（管理者・サポーター・ゲスト）が入るコレクションです。

| フィールド名 | 型 | 説明 |
|------------|-----|------|
| uid | string | Firebase Authentication のユーザーID |
| email | string | メールアドレス |
| displayName | string | 表示名（氏名） |
| phone | string | 電話番号 |
| role | string | ユーザー種別（`admin` / `supporter` / `guest`） |
| isActive | boolean | アカウントが有効かどうか |
| createdAt | timestamp | 作成日時 |
| updatedAt | timestamp | 更新日時 |

### 2. `supporters` コレクション（サポーター固有情報）

サポーター特有の情報（報酬関連）を保存するコレクションです。

| フィールド名 | 型 | 説明 |
|------------|-----|------|
| uid | string | Firebase Authentication のユーザーID |
| userId | string | `users` コレクションのドキュメントID |
| email | string | メールアドレス |
| name | string | 氏名 |
| phone | string | 電話番号 |
| hourlyRate | number | 時給（円） |
| transportationFee | number | 交通費（円） |
| isActive | boolean | アクティブ状態 |
| createdAt | timestamp | 作成日時 |
| updatedAt | timestamp | 更新日時 |

### なぜ2つに分けるのか？

```
┌─────────────────────────────────────────────────────────────┐
│  Firebase Authentication                                     │
│  ・ログイン認証を管理                                          │
│  ・メールアドレス・パスワードを保存                              │
└─────────────────────────────────────────────────────────────┘
                           ↓ uid で紐付け
┌─────────────────────────────────────────────────────────────┐
│  users コレクション                                           │
│  ・全ユーザー共通の情報                                        │
│  ・role で種別を区別（admin / supporter / guest）              │
└─────────────────────────────────────────────────────────────┘
                           ↓ uid で紐付け
┌─────────────────────────────────────────────────────────────┐
│  supporters コレクション                                      │
│  ・サポーター専用の追加情報                                     │
│  ・時給、交通費など報酬に関する情報                              │
└─────────────────────────────────────────────────────────────┘
```

**理由：**
- サポーターは「ユーザー」でもあり「サポーター」でもある
- ログイン機能は `users` + Firebase Auth で管理
- 報酬計算などサポーター固有の機能は `supporters` で管理
- 将来的に清掃タスク管理などと連携しやすい

---

## 機能一覧

### 1. サポーター一覧表示

**画面：** `/admin/supporters`

**動作：**
1. `supporters` コレクションから全データを取得
2. 一覧として表示（氏名、メール、時給、交通費、ステータス）

### 2. サポーター新規登録

**画面：** `/admin/supporters` のモーダル

**入力項目：**
- 氏名（必須）
- メールアドレス（必須）
- パスワード（必須、6文字以上）
- 電話番号
- 時給（デフォルト: 1,500円）
- 交通費（デフォルト: 500円）
- アクティブ状態

**処理フロー：**
```
[管理画面]
    ↓ POST /api/admin/create-supporter
[サーバーAPI]
    ↓ 1. Firebase Auth でユーザー作成
    ↓ 2. users コレクションに保存
    ↓ 3. supporters コレクションに保存
[完了]
```

**重要ポイント：**
- Firebase Admin SDK を使用してユーザーを作成
- 管理者のログイン状態に影響しない（Admin SDK は別セッション）

### 3. サポーター情報編集

**画面：** `/admin/supporters` のモーダル

**編集可能項目：**
- 氏名
- 電話番号
- 時給
- 交通費
- アクティブ状態

**注意：** メールアドレスとパスワードは編集不可（セキュリティ上の理由）

### 4. アクティブ状態の切り替え

**動作：**
- 一覧画面から直接 有効/無効 を切り替え
- 無効にするとサポーターはログインできなくなる（予定）

---

## API仕様

### POST `/api/admin/create-supporter`

サポーターを新規作成します。

**リクエスト：**
```json
{
  "email": "supporter@example.com",
  "password": "password123",
  "displayName": "山田太郎",
  "phone": "09012345678",
  "hourlyRate": 1500,
  "transportationFee": 500,
  "isActive": true
}
```

**レスポンス（成功）：**
```json
{
  "success": true,
  "userId": "firebase-auth-uid",
  "userDocId": "users-collection-doc-id",
  "supporterDocId": "supporters-collection-doc-id"
}
```

**エラーレスポンス：**
| ステータス | メッセージ |
|-----------|-----------|
| 400 | メールアドレス、パスワード、氏名は必須です |
| 400 | パスワードは6文字以上である必要があります |
| 400 | このメールアドレスは既に使用されています |
| 400 | メールアドレスの形式が正しくありません |
| 500 | サポーターの作成に失敗しました |

---

## セキュリティ

### CSRF対策

- `nuxt-csurf` モジュールで CSRF 保護を実装
- `/api/admin/*` は管理者認証で保護されているため CSRF 除外リストに追加

```typescript
// nuxt.config.ts
csurf: {
  excludedUrls: [
    ['/api/admin/.*', 'i'], // 管理者API（管理者認証で保護）
  ]
}
```

### Firestore セキュリティルール

```javascript
// supporters コレクション
match /supporters/{supporterId} {
  // 読み取り: 管理者のみ
  allow read: if isAdmin();
  // 書き込み: 管理者のみ
  allow write: if isAdmin();
}
```

---

## ファイル構成

```
furniturehouse1/
├── pages/
│   └── admin/
│       └── supporters.vue      # サポーター管理画面
├── server/
│   └── api/
│       └── admin/
│           └── create-supporter.post.ts  # サポーター作成API
├── types/
│   └── index.ts                # User型定義
└── nuxt.config.ts              # CSRF設定など
```

---

## 画面イメージ

### サポーター一覧画面

```
┌─────────────────────────────────────────────────────────────┐
│ ← 管理ダッシュボード    サポーター管理                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │
│  │登録サポーター数│ │アクティブ    │ │平均時給      │        │
│  │      2       │ │      2      │ │   ¥2,000    │        │
│  └──────────────┘ └──────────────┘ └──────────────┘        │
│                                                             │
│  [+ サポーターを追加]                                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 氏名        │ メール              │ 時給  │ 状態    │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ 田中花子    │ tanaka@example.com │ ¥2,500│ 有効 ● │   │
│  │ 佐藤一郎    │ sato@example.com   │ ¥1,500│ 有効 ● │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### サポーター追加モーダル

```
┌─────────────────────────────────────────┐
│         サポーター追加                   │
├─────────────────────────────────────────┤
│                                         │
│  氏名 *                                 │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  メールアドレス *                        │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  パスワード *                           │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  時給                    交通費         │
│  ┌───────────────┐  ┌───────────────┐ │
│  │ ¥ 1500       │  │ ¥ 500        │ │
│  └───────────────┘  └───────────────┘ │
│                                         │
│  ☑ アクティブ                           │
│                                         │
│  [  登録  ]           [キャンセル]       │
│                                         │
└─────────────────────────────────────────┘
```

---

## 今後の拡張予定

1. **清掃タスク管理との連携**
   - サポーターにタスクを割り当て
   - 完了報告の受付

2. **報酬計算機能**
   - 作業時間 × 時給 + 交通費 の自動計算
   - 月次レポート出力

3. **サポーター専用画面**
   - `/supporter/` 配下にサポーター用ダッシュボード
   - 割り当てられたタスクの確認・完了報告
