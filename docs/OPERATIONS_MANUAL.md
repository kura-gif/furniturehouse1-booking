# 家具の家 No.1 予約システム - システム保守運用マニュアル

**対象者**: 運用担当者・技術担当者
**最終更新**: 2026年1月22日

---

## 目次

### 【運用担当者向け】
1. [はじめに](#1-はじめに)
2. [日常業務](#2-日常業務)
3. [週次業務](#3-週次業務)
4. [月次業務](#4-月次業務)
5. [トラブル対応](#5-トラブル対応)
6. [よくある質問（FAQ）](#6-よくある質問faq)
7. [緊急対応](#7-緊急対応)

### 【技術者向け】
8. [自動処理・ログ確認](#8-技術者向け自動処理ログ確認)
9. [環境変数・定期メンテナンス](#9-技術者向け環境変数定期メンテナンス)
10. [システム保守運用](#10-システム保守運用)
11. [障害対応・復旧手順](#11-障害対応復旧手順)
12. [セキュリティ運用](#12-セキュリティ運用)
13. [連絡先・参考情報](#13-連絡先参考情報)

---

## 1. はじめに

### 1.1 このマニュアルについて

このマニュアルは、予約システムの運用に必要な情報をまとめています。
- **セクション1〜6**: 日常運用（プログラミング知識不要）
- **セクション7**: 緊急対応
- **セクション8〜9**: 技術者向け情報

基本的にすべての操作はWebブラウザ上の管理画面から行えます。

### 1.2 アクセス先一覧

| 用途 | URL |
|------|-----|
| **予約サイト（公開）** | https://booking.furniturehouse1.com |
| **管理画面** | https://booking.furniturehouse1.com/admin |
| **Stripeダッシュボード** | https://dashboard.stripe.com |
| **Vercelダッシュボード** | https://vercel.com/dashboard |
| **Firebaseコンソール** | https://console.firebase.google.com |

### 1.3 ログイン方法

1. 管理画面URL（/admin）にアクセス
2. 登録済みのメールアドレスでログイン
3. 管理者権限が付与されていれば管理画面が表示されます

---

## 2. 日常業務

### 2.1 新規予約の確認・審査（毎日 朝・夕）

**所要時間**: 5〜15分（予約数による）

#### 手順

```
1. 管理画面（/admin）にログイン

2. ダッシュボードで「審査待ち」の予約を確認
   - オレンジ色のバッジ「審査待ち」が表示されます

3. 予約をクリックして詳細を確認
   - ゲスト名
   - メールアドレス
   - 電話番号
   - チェックイン日・チェックアウト日
   - 人数
   - 合計金額

4. 審査判断
   ┌─────────────────────────────────────────┐
   │ 【承認する場合】                         │
   │  「承認」ボタンをクリック                │
   │  → 自動でクレジットカード決済が確定     │
   │  → ゲストに承認メールが送信される       │
   │  → 清掃タスクが自動生成される           │
   ├─────────────────────────────────────────┤
   │ 【却下する場合】                         │
   │  「却下」ボタンをクリック                │
   │  → 却下理由を選択（必須）               │
   │  → 与信が解放される（課金されない）     │
   │  → ゲストに却下メールが送信される       │
   └─────────────────────────────────────────┘
```

#### 審査のポイント

| 確認項目 | チェック内容 |
|----------|-------------|
| 連絡先 | メール・電話番号が有効か |
| 日程 | 他の予約と重複していないか |
| 人数 | 最大収容人数を超えていないか |
| 特記事項 | 特別な要望がないか |
| 宿泊者情報 | 住所・職業が入力されているか |
| 外国籍ゲスト | 国籍・パスポート番号が入力されているか |

> **法定要件（旅館業法/住宅宿泊事業法）**:
> 宿泊者名簿として「氏名・住所・職業」の記録が義務付けられています。
> 外国籍の方は「国籍・パスポート番号」も必須です。
> これらの情報は予約フォームで収集され、Firestoreに保存されます（3年間保管）。

#### 注意事項

- **審査期限**: 与信確保から **48時間以内** に承認/却下してください
- 期限を過ぎると与信が自動解放される可能性があります
- 迷った場合は承認せず、ゲストに連絡して確認してください

---

### 2.2 ゲストメッセージの確認（毎日）

**所要時間**: 5〜10分

#### 手順

```
1. 管理画面 → 「メッセージ」メニュー

2. 未読メッセージがあれば赤いバッジが表示されます

3. メッセージをクリックして内容を確認

4. 返信が必要な場合は入力して送信
   → ゲストにメール通知が届きます
```

#### よくある問い合わせ内容

| 問い合わせ | 対応方法 |
|-----------|----------|
| チェックイン時間の確認 | ガイドページのURLを案内 |
| キャンセル希望 | キャンセル手順を案内（または代行） |
| 日程変更希望 | 一度キャンセル→再予約を案内 |
| 設備についての質問 | 具体的に回答 |

---

### 2.3 本日のチェックイン/チェックアウト確認

**所要時間**: 5分

```
1. 管理画面ダッシュボード

2. 「本日のチェックイン」「本日のチェックアウト」を確認

3. チェックアウト後の清掃タスクが作成されているか確認
```

---

## 3. 週次業務

### 3.1 清掃タスクの割り当て（毎週）

**所要時間**: 15〜30分
**実施タイミング**: 翌週の予約が確定した後

#### 手順

```
1. 管理画面 → 「清掃タスク」メニュー

2. 「未割当」のタスクを確認

3. タスクをクリック → サポーターを選択

4. 「割り当て」ボタンをクリック
   → サポーターにメール通知が届きます
```

#### 清掃タスクの種類

| タイプ | タイミング | 内容 |
|--------|-----------|------|
| チェックイン前清掃 | チェックイン当日 | 部屋の準備、アメニティ補充 |
| チェックアウト後清掃 | チェックアウト当日 | 清掃、備品確認、リネン交換 |

---

### 3.2 サポーター勤務可能日の確認

```
1. 管理画面 → 「サポーター」メニュー

2. 各サポーターの「勤務可能日」を確認

3. 翌週の予約に対応できるサポーターがいるか確認

4. 不足している場合はサポーターに連絡
```

---

### 3.3 レビューの承認

**所要時間**: 10分

```
1. 管理画面 → 「レビュー」メニュー

2. 「承認待ち」のレビューを確認

3. 内容を確認
   - 不適切な内容がないか
   - 個人情報が含まれていないか

4. 問題なければ「承認」をクリック
   → 公開サイトに表示されます
```

---

## 4. 月次業務

### 4.1 料金設定の確認・更新

**所要時間**: 15〜30分
**実施タイミング**: 月末または季節変更前

```
1. 管理画面 → 「設定」→「料金設定」

2. 以下を確認・更新:
   - 基本料金
   - 週末料金
   - 追加ゲスト料金
   - クリーニング料金

3. 特別期間（GW、年末年始等）があれば設定

4. 「保存」をクリック
```

---

### 4.2 クーポンの管理

```
1. 管理画面 → 「クーポン」メニュー

2. 有効期限切れのクーポンを確認
   → 必要に応じて無効化

3. 新規クーポンが必要な場合:
   - 「新規作成」をクリック
   - クーポンコード（例: SUMMER2026）
   - 割引タイプ（固定額 or パーセント）
   - 割引額
   - 有効期限
   - 使用回数上限
```

---

### 4.3 Stripe売上の確認

**所要時間**: 10分

```
1. Stripe Dashboard（https://dashboard.stripe.com）にログイン

2. 左メニュー → 「Payments」

3. 月間の売上を確認:
   - 成功した決済
   - 返金
   - 失敗した決済

4. 必要に応じてレポートをダウンロード
```

---

### 4.4 サポーター報酬レポートの確認

```
1. 管理画面 → 「報酬レポート」

2. 月間の清掃実績を確認

3. 各サポーターの報酬額を確認

4. 支払い処理（銀行振込等）を実施
```

---

## 5. トラブル対応

### 5.1 よくあるトラブルと対処法

#### 「予約確認メールが届かない」とゲストから連絡

```
1. まず迷惑メールフォルダを確認してもらう

2. メールアドレスが正しいか管理画面で確認

3. 正しい場合:
   - 管理画面から予約詳細を開く
   - 必要な情報を直接メールで送信

4. 間違っている場合:
   - メールアドレスを修正
   - 確認メールを再送信
```

#### 「決済がエラーになった」とゲストから連絡

```
1. Stripe Dashboard で該当の決済を確認

2. エラー理由を確認:
   - カード拒否 → 別のカードを試してもらう
   - 残高不足 → 別のカードを試してもらう
   - 3Dセキュア失敗 → 再度試してもらう

3. 予約画面から再度決済を案内
```

#### 「キャンセルしたい」とゲストから連絡

```
1. キャンセルポリシーを確認:
   ┌─────────────────────────────────────┐
   │ チェックイン7日以上前: 100%返金     │
   │ チェックイン3-6日前:   50%返金      │
   │ チェックイン1-2日前:   30%返金      │
   │ チェックイン当日:      返金なし     │
   └─────────────────────────────────────┘

2. ゲストに返金額を案内

3. 了承を得たら管理画面でキャンセル処理:
   - 予約詳細 → 「キャンセル」ボタン
   - 返金額が自動計算される
   - 確認して実行
```

#### サイトが表示されない

```
1. 自分のインターネット接続を確認

2. Vercel Status（https://www.vercel-status.com/）を確認
   - 障害が発生していないか

3. 障害の場合:
   - 復旧を待つ
   - 緊急の場合は開発担当者に連絡

4. 障害でない場合:
   - 開発担当者に連絡
```

#### Stripeで「Webhook失敗」が表示される

```
1. Stripe Dashboard → Developers → Webhooks

2. 失敗しているイベントを確認

3. エラー内容を確認:
   - 「Connection failed」: サイトがダウンしている可能性
   - 「Signature verification failed」: 設定ミスの可能性

4. 開発担当者に連絡（エラー内容を共有）
```

#### 予約データの不整合

```
1. Firestoreで予約データを確認

2. Stripeで決済状態を確認

3. 不整合がある場合:
   - 管理画面「整合性チェック」機能を使用
   - または手動でFirestoreを更新
```

---

## 6. よくある質問（FAQ）

### Q1: 予約を管理者側で作成できますか？

**A**: 現在の仕組みでは、ゲスト自身が予約フォームから入力する必要があります。
電話予約などの場合は、ゲストに代わって予約フォームに入力するか、ゲストにURLを案内してください。

---

### Q2: 予約日程を変更できますか？

**A**: 管理画面から直接の日程変更はできません。
以下の手順で対応してください:

1. 既存の予約をキャンセル（全額返金）
2. ゲストに新しい日程で再予約してもらう

---

### Q3: クーポンの使用状況を確認したい

**A**: 管理画面 → クーポン → 該当クーポンをクリック
「使用回数」で確認できます。

---

### Q4: 特定の日を予約不可にしたい

**A**: 管理画面 → 設定 → 「ブロック日」で設定できます。
メンテナンス日や私用日などを設定してください。

---

### Q5: サポーターを追加したい

**A**: 管理画面 → サポーター → 「新規追加」
以下の情報を入力して登録します：

- メールアドレス
- 初期パスワード（**8文字以上、大文字・小文字・数字を含む**）
- 氏名
- 電話番号
- 時給・交通費

> **注意**: 登録後、サポーターには入力したメールアドレスとパスワードを別途お知らせください。

---

### Q6: 過去の予約履歴を確認したい

**A**: 管理画面 → 予約一覧
フィルターで「過去の予約」を選択すると表示されます。

---

### Q7: Gmailの送信制限に達した

**A**: Gmailは1日500通までの送信制限があります。
大量のメール送信が必要な場合は開発担当者に相談してください。

---

## 7. 緊急対応

### 7.1 サイトダウン時

```
1. Vercel Status確認: https://www.vercel-status.com/

2. 直近のデプロイを確認

3. 必要に応じて前バージョンにロールバック:
   - Vercelダッシュボード → Deployments → 「...」 → Promote to Production
```

**サイトが長時間ダウンしている場合**:

1. 予約ページへのアクセスを一時停止（可能であれば）
2. 既存の予約者への連絡準備
3. 電話での予約受付を検討

### 7.2 決済システム障害時

```
1. Stripe Status確認: https://status.stripe.com/

2. 新規予約を一時停止（サイト設定で対応）

3. 復旧後に滞留した処理を確認
```

**対応方針**:
1. 新規予約の受付を一時停止
2. 既存の審査待ち予約は保留
3. 復旧後にまとめて処理

### 7.3 データベース障害時

```
1. Firebase Status確認: https://status.firebase.google.com/

2. 読み取り専用モードで対応検討

3. 復旧後にデータ整合性チェック実行
```

### 7.4 緊急時の連絡先

| 状況 | 連絡先 | 備考 |
|------|--------|------|
| サイト障害 | 開発担当: __________ | |
| 決済トラブル | Stripe Support | https://support.stripe.com |
| 予約に関する緊急対応 | 運用責任者: __________ | |

---

## 8. 【技術者向け】自動処理・ログ確認

### 8.1 自動処理（Cronジョブ）

システムは以下のCronジョブを自動実行します。

#### 実行スケジュール

| ジョブ | 実行時刻 | エンドポイント | 処理内容 |
|--------|---------|----------------|----------|
| チェックインリマインダー | 毎日 00:00 UTC | `/api/cron/send-reminders` | チェックイン前日にメール送信 |
| サンキューメール | 毎日 01:00 UTC | `/api/cron/send-thankyou` | チェックアウト翌日にメール送信 |
| 与信期限チェック | 毎日 03:00 UTC | `/api/cron/expire-authorizations` | 72時間で警告、7日で自動キャンセル |
| 整合性チェック | 毎日 04:00 UTC | `/api/cron/consistency-check` | Stripe/Firestore整合性を自動検証 |

#### Cronジョブのログ確認

すべてのCronジョブは実行結果をFirestoreの `operationLogs` コレクションに自動保存します。

```
Firestore > operationLogs
  - category: "cron"
  - action: "CRON_COMPLETED" または "CRON_FAILED"
  - duration: 処理時間（ミリ秒）
  - data: { jobName, results }
```

#### 与信期限管理の詳細

1. **72時間経過**: 管理者に警告メール送信
2. **168時間（7日）経過**: 自動キャンセル処理
   - 与信を解放
   - ゲストにキャンセル通知
   - ステータスを `expired` に更新

#### ヘルスチェック

外部監視サービス（UptimeRobot等）から以下のエンドポイントを監視できます:

```
GET /api/health

レスポンス例:
{
  "status": "healthy",
  "services": {
    "firestore": { "status": "healthy", "latency": 45 },
    "stripe": { "status": "healthy", "latency": 120 }
  }
}
```

- 200: 正常
- 503: サービス異常

#### 運用ログの確認

重要な操作は自動的にFirestoreの `operationLogs` コレクションに保存されます:

| カテゴリ | 記録される操作 |
|---------|---------------|
| booking | 予約作成、承認、却下、キャンセル |
| payment | 与信確保、決済確定、返金 |
| email   | メール送信成功/失敗 |
| cron    | 定期ジョブの開始/完了/失敗 |
| admin   | 管理者操作（設定変更等） |
| error   | 予期しないエラー |

Firebaseコンソールで `operationLogs` コレクションを確認することで、
過去の操作履歴を追跡できます

### 8.2 決済状態の確認

| ステータス | 説明 |
|-----------|------|
| requires_capture | 与信確保済み（審査待ち）|
| succeeded | 決済完了 |
| canceled | キャンセル済み |
| requires_payment_method | 決済失敗 |

#### 与信期限について

- Stripe与信確保は7日間有効
- 7日以内に承認または却下が必要
- 毎日午前3時のCronで期限切れチェック実行

### 8.3 ログの確認方法

#### Vercelログ

1. Vercelダッシュボード → プロジェクト選択
2. 「Logs」タブ → 「Functions」フィルター
3. エラーログを時系列で確認

#### Firestoreエラーログ

- コレクション: `errorLogs`
- 予約作成失敗などのエラーが記録される

---

## 9. 【技術者向け】環境変数・定期メンテナンス

### 9.1 環境変数一覧

#### 必須環境変数

| 変数名 | 説明 |
|--------|------|
| STRIPE_SECRET_KEY | Stripe シークレットキー |
| STRIPE_WEBHOOK_SECRET | Stripe Webhook シークレット |
| FIREBASE_ADMIN_KEY | Firebase Admin SDK キー（Base64） |
| INTERNAL_API_SECRET | 内部API認証シークレット |
| SMTP_HOST | メールサーバーホスト |
| SMTP_USER | メール送信ユーザー |
| SMTP_PASS | メール送信パスワード |

#### オプション環境変数

| 変数名 | 説明 |
|--------|------|
| CRON_SECRET | Cron認証シークレット |
| SENTRY_DSN | Sentry DSN（エラー監視） |
| SENTRY_ORG | Sentry組織名 |
| SENTRY_PROJECT | Sentryプロジェクト名 |
| SENTRY_AUTH_TOKEN | Sentryソースマップ用トークン |
| UPSTASH_REDIS_REST_URL | Upstash Redis REST URL（レート制限） |
| UPSTASH_REDIS_REST_TOKEN | Upstash Redis RESTトークン（レート制限） |

### 9.2 定期メンテナンス

#### 週次タスク

- [ ] 予約データのバックアップ確認
- [ ] エラーログの確認とクリア
- [ ] 期限切れクーポンの確認

#### 月次タスク

- [ ] Stripeの決済レポート確認
- [ ] サーバーコスト（Vercel/Firebase）確認
- [ ] セキュリティアップデート確認
- [ ] 依存パッケージの更新検討

#### 年次タスク

- [ ] SSL証明書の有効期限確認（Vercel自動更新）
- [ ] プライバシーポリシー・利用規約の見直し
- [ ] 災害復旧計画の見直し

---

## 10. システム保守運用

このセクションでは、システムを安定稼働させるための保守運用手順を説明します。

### 10.1 バックアップ運用

#### 自動バックアップ

Firestoreデータは以下のスケジュールで自動バックアップされます：

| 種類 | 頻度 | 保持期間 | 保存先 |
|------|------|----------|--------|
| 日次バックアップ | 毎日 03:00 JST | 7日間 | `gs://furniturehouse1-backups/daily-*` |
| 週次バックアップ | 毎週日曜 03:00 JST | 4週間 | `gs://furniturehouse1-backups/weekly-*` |
| 月次バックアップ | 毎月1日 03:00 JST | 12ヶ月 | `gs://furniturehouse1-backups/monthly-*` |

#### 手動バックアップ

大きな変更前やメンテナンス前に実行：

```bash
# gcloud CLIでバックアップ
gcloud firestore export gs://furniturehouse1-backups/manual-$(date +%Y%m%d-%H%M%S) \
  --project=furniture-house-1

# バックアップ一覧確認
gsutil ls gs://furniturehouse1-backups/
```

#### バックアップ検証（月次）

毎月、バックアップが正常に作成されているか確認：

```bash
# 最新10件のバックアップを確認
gsutil ls -l gs://furniturehouse1-backups/ | sort -k2 | tail -10

# ファイルサイズが妥当か確認（急激な減少は異常）
```

**詳細設定**: [BACKUP_SETUP.md](./BACKUP_SETUP.md)

---

### 10.2 モニタリング運用

#### 死活監視

UptimeRobotなどの外部サービスで以下を監視：

| 監視対象 | URL | 間隔 |
|---------|-----|------|
| サイト死活 | `https://booking.furniturehouse1.com/` | 5分 |
| ヘルスチェック | `https://booking.furniturehouse1.com/api/health` | 5分 |

#### ヘルスチェックの確認

```bash
curl https://booking.furniturehouse1.com/api/health
```

正常時のレスポンス：
```json
{
  "status": "healthy",
  "services": {
    "firestore": { "status": "healthy", "latency": 45 },
    "stripe": { "status": "healthy", "latency": 120 }
  }
}
```

#### 日次モニタリングチェック

| 確認項目 | 確認方法 | 対応 |
|---------|---------|------|
| サイト表示 | 本番URL確認 | 障害時はVercelロールバック |
| 決済状況 | Stripe Dashboard | 失敗決済の確認・対応 |
| Webhook | Stripe Developers | 配信失敗の再送 |
| エラーログ | Firestore `operationLogs` | エラー原因調査 |

**詳細設定**: [MONITORING_SETUP.md](./MONITORING_SETUP.md)

---

### 10.3 定期メンテナンス作業

#### 週次メンテナンス

| 作業 | 内容 | 担当 |
|------|------|------|
| ログ確認 | `operationLogs` でエラー確認 | 運用 |
| 整合性チェック | Firestore/Stripe整合性確認 | 自動 |
| 期限切れクーポン | 無効化処理 | 運用 |

#### 月次メンテナンス

| 作業 | 内容 | 担当 |
|------|------|------|
| バックアップ検証 | バックアップファイル確認 | 技術 |
| コスト確認 | Vercel/Firebase/Stripe請求確認 | 運用 |
| 依存パッケージ確認 | セキュリティアップデート | 技術 |
| 古いログ削除 | 3ヶ月以上前のログ削除検討 | 技術 |

#### 年次メンテナンス

| 作業 | 内容 | 担当 |
|------|------|------|
| SSL証明書 | Vercel自動更新のため確認のみ | 技術 |
| 利用規約・プライバシーポリシー | 法改正対応 | 運用 |
| 災害復旧訓練 | バックアップ復元テスト | 技術 |
| APIキーローテーション | Stripeキー更新検討 | 技術 |

---

### 10.4 データ管理・クリーンアップ

#### 古いデータの削除基準

| データ種類 | 保持期間 | 根拠 |
|-----------|---------|------|
| 予約データ | 3年 | 旅館業法（宿泊者名簿） |
| 決済データ | 7年 | 税法（帳簿保存義務） |
| 運用ログ | 1年 | 運用判断 |
| エラーログ | 3ヶ月 | 運用判断 |

#### ログクリーンアップ手順

```javascript
// Firestore Console または管理ツールで実行
// 3ヶ月以上前のエラーログを削除

const cutoffDate = new Date();
cutoffDate.setMonth(cutoffDate.getMonth() - 3);

// errorLogs コレクションから古いドキュメントを削除
const snapshot = await db.collection('errorLogs')
  .where('timestamp', '<', cutoffDate)
  .get();

// バッチ削除（500件ずつ）
```

---

### 10.5 デプロイ・リリース管理

#### デプロイ方法

**方法1: GitHub経由（推奨）**
```bash
git add .
git commit -m "fix: 修正内容"
git push origin main
# → GitHub Actionsで自動デプロイ
```

**方法2: 手動デプロイ**
```bash
./scripts/deploy.sh
```

**方法3: Vercel CLI**
```bash
vercel --prod
```

#### デプロイ前チェックリスト

- [ ] ローカルでビルド成功 (`npm run build`)
- [ ] ローカルでテスト通過
- [ ] 環境変数の変更がある場合、Vercelに設定済み
- [ ] 破壊的変更がある場合、ロールバック手順を確認

#### ロールバック手順

問題発生時は前のバージョンに戻す：

1. Vercel Dashboard → Deployments
2. 戻したいデプロイの「...」→「Promote to Production」
3. サイト動作確認

**詳細**: [DEPLOYMENT.md](./DEPLOYMENT.md)

---

## 11. 障害対応・復旧手順

### 11.1 障害レベル定義

| レベル | 定義 | 対応時間目標 | 例 |
|--------|------|-------------|-----|
| Critical | サービス全停止 | 30分以内 | サイトダウン、決済不可 |
| High | 主要機能停止 | 2時間以内 | 予約作成不可、メール送信不可 |
| Medium | 一部機能障害 | 24時間以内 | 管理画面の一部エラー |
| Low | 軽微な問題 | 次回リリース | UIの軽微な不具合 |

---

### 11.2 サイトダウン時の対応

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 状況確認                                                  │
├─────────────────────────────────────────────────────────────┤
│ - https://booking.furniturehouse1.com/ にアクセス           │
│ - https://www.vercel-status.com/ でVercel障害確認          │
│ - https://status.firebase.google.com/ でFirebase障害確認   │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 原因特定                                                  │
├─────────────────────────────────────────────────────────────┤
│ 【外部障害の場合】                                           │
│ → 復旧を待つ + 状況を監視                                   │
│                                                             │
│ 【デプロイ起因の場合】                                       │
│ → Vercelでロールバック実行                                  │
│                                                             │
│ 【原因不明の場合】                                           │
│ → 開発担当者に連絡                                          │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 復旧確認                                                  │
├─────────────────────────────────────────────────────────────┤
│ - サイト表示確認                                             │
│ - ヘルスチェック: /api/health                               │
│ - テスト予約（本番では行わない）                             │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 事後対応                                                  │
├─────────────────────────────────────────────────────────────┤
│ - 障害報告書作成                                             │
│ - 影響を受けた予約の確認                                     │
│ - 再発防止策の検討                                           │
└─────────────────────────────────────────────────────────────┘
```

---

### 11.3 決済障害時の対応

#### Stripe障害の場合

1. https://status.stripe.com/ で障害確認
2. 新規予約の受付を一時停止（サイト設定で対応）
3. 審査待ち予約は保留
4. 復旧後、滞留した処理を確認

#### 与信エラーの対応

| エラー | 原因 | 対応 |
|--------|------|------|
| card_declined | カード拒否 | ゲストに別カード依頼 |
| insufficient_funds | 残高不足 | ゲストに別カード依頼 |
| authentication_required | 3Dセキュア失敗 | 再試行依頼 |
| expired_card | カード期限切れ | 別カード依頼 |

---

### 11.4 データ復旧手順

#### Firestoreからの復元

```bash
# 1. バックアップ一覧確認
gsutil ls gs://furniturehouse1-backups/

# 2. 復元前に現状を保存
gcloud firestore export gs://furniturehouse1-backups/pre-restore-$(date +%Y%m%d-%H%M%S)

# 3. バックアップからインポート（全データ）
gcloud firestore import gs://furniturehouse1-backups/[バックアップ名]

# 4. 特定コレクションのみ復元する場合
gcloud firestore import gs://furniturehouse1-backups/[バックアップ名] \
  --collection-ids=bookings,users
```

**注意**: インポートは既存データを上書きします。必ず事前に現状をバックアップしてください。

#### 個別データの復旧

1. Firebaseコンソールでバックアップを確認
2. 必要なドキュメントを特定
3. 手動でデータを復元

---

### 11.5 障害報告書テンプレート

```markdown
# 障害報告書

## 基本情報
- 発生日時: YYYY/MM/DD HH:MM
- 復旧日時: YYYY/MM/DD HH:MM
- 影響時間: X時間X分
- 障害レベル: Critical / High / Medium / Low

## 影響範囲
- 影響を受けたサービス:
- 影響を受けたユーザー数:
- 影響を受けた予約数:

## 原因
（詳細な原因を記載）

## 対応内容
1.
2.
3.

## 再発防止策
1.
2.
3.

## 担当者
- 対応者:
- 報告者:
```

---

## 12. セキュリティ運用

### 12.1 日常的なセキュリティ確認

| 確認項目 | 頻度 | 方法 |
|---------|------|------|
| 不審なログイン試行 | 日次 | Firebase Authentication確認 |
| 異常な決済パターン | 日次 | Stripe Radar確認 |
| 管理者アカウント確認 | 週次 | 不要なアカウントの無効化 |
| アクセスログ確認 | 週次 | Vercel Analytics確認 |

---

### 12.2 APIキー・シークレット管理

#### キーローテーション

| キー | ローテーション頻度 | 手順 |
|------|------------------|------|
| Stripe APIキー | 年1回 or 漏洩時 | Stripeで新キー発行→環境変数更新→旧キー無効化 |
| Firebase Admin Key | 年1回 or 漏洩時 | 新サービスアカウント作成→環境変数更新→旧キー削除 |
| INTERNAL_API_SECRET | 年1回 | 新シークレット生成→環境変数更新 |
| Vercel Token | 年1回 | 新トークン発行→GitHub Secrets更新→旧トークン削除 |

#### キー漏洩時の対応

1. **即座に該当キーを無効化**
2. 新しいキーを発行
3. すべての環境（Vercel、GitHub Secrets）を更新
4. デプロイして反映
5. 漏洩経路の調査・対策

---

### 12.3 Firestoreセキュリティルール

現在のルール概要：

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証必須
    // 管理者のみ書き込み可能なコレクション
    // ユーザーは自分のデータのみアクセス可能
  }
}
```

#### ルールの更新手順

```bash
# 1. firestore.rules を編集

# 2. デプロイ
firebase deploy --only firestore:rules

# 3. 動作確認
```

---

### 12.4 依存パッケージのセキュリティ

#### 脆弱性チェック

```bash
# 脆弱性スキャン
npm audit

# 自動修正（可能な場合）
npm audit fix

# 詳細レポート
npm audit --json > audit-report.json
```

#### 対応基準

| 重大度 | 対応 |
|--------|------|
| Critical | 即座に対応 |
| High | 1週間以内に対応 |
| Moderate | 次回リリース時に対応 |
| Low | 対応検討 |

---

### 12.5 インシデント対応

#### 不正アクセス検知時

1. 該当アカウントの即時無効化
2. アクセスログの保全
3. 影響範囲の特定
4. 必要に応じてサービス停止
5. 原因調査・対策実施
6. 関係者への報告

#### 個人情報漏洩時

1. 漏洩範囲の特定
2. 経営層・法務への報告
3. 個人情報保護委員会への報告（必要に応じて）
4. 影響を受けた顧客への通知
5. 再発防止策の実施

---

## 13. 連絡先・参考情報

### 13.1 サポート連絡先

| 役割 | 名前 | 連絡先 | 対応時間 |
|------|------|--------|----------|
| 開発担当 | | | |
| 運用責任者 | | | |

### 10.2 外部サービス Status ページ

| サービス | URL |
|----------|-----|
| Vercel | https://www.vercel-status.com/ |
| Stripe | https://status.stripe.com/ |
| Firebase | https://status.firebase.google.com/ |
| Gmail | https://www.google.com/appsstatus |

### 10.3 参考ドキュメント

| ドキュメント | 場所 |
|-------------|------|
| システム設計書 | docs/SYSTEM_DESIGN_DOCUMENT.md |
| リリース管理表 | docs/RELEASE_MANAGEMENT.md |
| セキュリティガイド | SECURITY.md |
| 環境変数設定 | docs/setup/ENVIRONMENT_VARIABLES.md |

### 10.4 主要リンク

- **本番サイト**: https://booking.furniturehouse1.com
- **管理画面**: https://booking.furniturehouse1.com/admin
- **Vercelダッシュボード**: https://vercel.com/dashboard
- **Stripeダッシュボード**: https://dashboard.stripe.com
- **Firebaseコンソール**: https://console.firebase.google.com
- **管理者メール**: furniturehouse1@chladni.co.jp

---

## 更新履歴

| 日付 | 内容 | 更新者 |
|------|------|--------|
| 2026/01/22 | パスワードポリシー追記、予約承認時の清掃タスク自動生成を追記 | |
| 2026/01/21 | システム保守運用・障害対応・セキュリティ運用セクション追加 | |
| 2026/01/20 | ドキュメント整理・更新 | |
| 2026/01/19 | OPERATION_MANUAL.mdと統合、構成を整理 | |
| 2026/01/17 | 初版作成 | |

---

*このマニュアルは定期的に更新されます。不明点があれば開発担当者にお問い合わせください。*
