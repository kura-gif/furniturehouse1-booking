<template>
  <div class="min-h-screen bg-gray-50">
    <AppHeader />

    <div class="max-w-4xl mx-auto px-6 py-12 mt-16">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="mb-8">
        <button @click="$router.back()" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          æˆ»ã‚‹
        </button>
        <h1 class="text-3xl font-semibold mb-6" style="color: #231815;">äºˆç´„ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h1>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ -->
        <div class="flex items-center justify-center">
          <div class="flex items-center w-full max-w-2xl">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—1 -->
            <div class="flex items-center flex-1">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center font-semibold">
                  1
                </div>
                <span class="ml-2 text-sm font-medium text-gray-900 hidden sm:inline">äºˆç´„å†…å®¹</span>
              </div>
            </div>
            <div class="flex-1 h-0.5 bg-purple-600 mx-2"></div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—2 -->
            <div class="flex items-center flex-1">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center font-semibold">
                  2
                </div>
                <span class="ml-2 text-sm font-medium text-gray-900 hidden sm:inline">ãŠå®¢æ§˜æƒ…å ±</span>
              </div>
            </div>
            <div class="flex-1 h-0.5 bg-gray-200 mx-2"></div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—3 -->
            <div class="flex items-center flex-1">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-semibold">
                  3
                </div>
                <span class="ml-2 text-sm font-medium text-gray-400 hidden sm:inline">ãŠæ”¯æ‰•ã„</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- å·¦å´: ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="lg:col-span-2 space-y-8">
          <!-- ã‚¹ãƒ†ãƒƒãƒ—1: äºˆç´„å†…å®¹ã®ç¢ºèª -->
          <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
            <h2 class="text-xl font-semibold mb-4" style="color: #231815;">
              1. äºˆç´„å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„
            </h2>

            <div class="space-y-4">
              <!-- äºˆç´„å†…å®¹ -->
              <div class="border-b border-gray-200 pb-4">
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
                    <span class="text-gray-900">{{ formatDisplayDate(checkInDate) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span>
                    <span class="text-gray-900">{{ formatDisplayDate(checkOutDate) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">å®¿æ³Šäººæ•°</span>
                    <span class="text-gray-900">å¤§äºº{{ adults }}äººã€ä¹³å¹¼å…{{ children }}äºº</span>
                  </div>
                </div>
              </div>

              <!-- æ–™é‡‘è©³ç´° -->
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Â¥{{ pricePerNight.toLocaleString() }} Ã— {{ numberOfNights }}æ³Š</span>
                  <span class="text-gray-900">Â¥{{ subtotal.toLocaleString() }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">ç¨é‡‘</span>
                  <span class="text-gray-900">Â¥{{ taxAmount.toLocaleString() }}</span>
                </div>
                <div class="flex justify-between pt-2 border-t border-gray-200 font-semibold text-base">
                  <span>åˆè¨ˆï¼ˆJPYï¼‰</span>
                  <span>Â¥{{ totalAmount.toLocaleString() }}</span>
                </div>
              </div>

              <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ -->
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç„¡æ–™</h3>
                <p class="text-sm text-gray-700">
                  {{ cancellationDeadline }}ã¾ã§ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚Œã°ã€å…¨é¡ãŒè¿”é‡‘ã•ã‚Œã¾ã™ã€‚
                </p>
              </div>
            </div>
          </div>

          <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ã‚²ã‚¹ãƒˆæƒ…å ±ã®å…¥åŠ› -->
          <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
            <h2 class="text-xl font-semibold mb-4" style="color: #231815;">
              2. ã‚²ã‚¹ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
            </h2>

            <div class="space-y-4 mb-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ãŠåå‰ <span class="text-red-500">*</span>
                </label>
                <input
                  v-model="guestName"
                  type="text"
                  placeholder="å±±ç”° å¤ªéƒ"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="text-red-500">*</span>
                </label>
                <input
                  v-model="guestEmail"
                  type="email"
                  placeholder="example@email.com"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  é›»è©±ç•ªå· <span class="text-red-500">*</span>
                </label>
                <input
                  v-model="guestPhone"
                  type="tel"
                  placeholder="090-1234-5678"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                />
              </div>
            </div>

            <h3 class="text-lg font-semibold mb-4" style="color: #231815;">
              ãŠæ”¯æ‰•ã„æƒ…å ±
            </h3>

            <!-- Stripe Card Element -->
            <div v-if="paymentReady" class="space-y-4">
              <div id="card-element" class="p-4 border border-gray-200 rounded-lg bg-white"></div>
              <p class="text-xs text-gray-500">
                ãŠæ”¯æ‰•ã„æƒ…å ±ã¯å®‰å…¨ã«æš—å·åŒ–ã•ã‚Œã¦å‡¦ç†ã•ã‚Œã¾ã™
              </p>
            </div>

            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ -->
            <div v-else class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mb-2"></div>
              <p class="text-sm text-gray-600">æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æº–å‚™ä¸­...</p>
            </div>
          </div>

          <!-- åŒæ„äº‹é … -->
          <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
            <label class="flex items-start gap-3 cursor-pointer">
              <input
                type="checkbox"
                v-model="agreedToTerms"
                class="mt-1 w-5 h-5 text-purple-600 focus:ring-purple-500 rounded"
              />
              <span class="text-sm text-gray-700">
                <strong>ãƒã‚¦ã‚¹ãƒ«ãƒ¼ãƒ«</strong>ã€<strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼</strong>ã€ãŠã‚ˆã³
                <strong>ã‚²ã‚¹ãƒˆã¸ã®è¿”é‡‘ãƒãƒªã‚·ãƒ¼</strong>ã«åŒæ„ã—ã¾ã™ã€‚ã¾ãŸã€å®¶å…·ã®å®¶ãŒ
                <strong>æ”¯æ‰•ã„ã«é–¢ã™ã‚‹è¦ç´„</strong>ã«å¾“ã£ã¦æ–™é‡‘ã®è«‹æ±‚ã‚’è¡Œã†ã“ã¨ã«åŒæ„ã—ã¾ã™ã€‚
              </span>
            </label>
          </div>

          <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
          <div class="flex gap-4">
            <button
              type="button"
              @click="$router.back()"
              class="flex-1 px-6 py-4 border-2 border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button
              type="button"
              @click="handleSubmit"
              :disabled="!isFormValid || isSubmitting"
              class="flex-1 px-6 py-4 text-white font-medium rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
            >
              {{ isSubmitting ? 'å‡¦ç†ä¸­...' : 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡' }}
            </button>
          </div>
        </div>

        <!-- å³å´: äºˆç´„ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200 sticky top-24">
            <!-- ç‰©ä»¶æƒ…å ± -->
            <div class="flex gap-4 mb-6 pb-6 border-b border-gray-200">
              <img
                src="https://storage.googleapis.com/production-os-assets/assets/ee624b9f-8615-4f77-a680-72fbc0876d71"
                alt="å®¶å…·ã®å®¶ No.1"
                class="w-24 h-24 rounded-lg object-cover"
              />
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900 mb-1">å®¶å…·ã®å®¶ No.1</h3>
                <p class="text-sm text-gray-600">å®¶å…·ã®å®¶ No.1ã«æ»åœ¨ã™ã‚‹</p>
              </div>
            </div>

            <!-- æ—¥ç¨‹ -->
            <div class="mb-6 pb-6 border-b border-gray-200">
              <h4 class="font-semibold text-gray-900 mb-3">æ—¥ç¨‹</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
                  <span class="text-gray-900">{{ formatDisplayDate(checkInDate) }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span>
                  <span class="text-gray-900">{{ formatDisplayDate(checkOutDate) }}</span>
                </div>
              </div>
            </div>

            <!-- ã‚²ã‚¹ãƒˆ -->
            <div class="mb-6 pb-6 border-b border-gray-200">
              <h4 class="font-semibold text-gray-900 mb-3">ã‚²ã‚¹ãƒˆ</h4>
              <p class="text-sm text-gray-900">å¤§äºº{{ adults }}äººã€ä¹³å¹¼å…{{ children }}äºº</p>
            </div>

            <!-- æ–™é‡‘ã®è©³ç´° -->
            <div class="space-y-3 text-sm mb-6">
              <div class="flex justify-between">
                <span class="text-gray-600 underline">Â¥{{ pricePerNight.toLocaleString() }} x {{ numberOfNights }}æ³Š</span>
                <span class="text-gray-900">Â¥{{ subtotal.toLocaleString() }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 underline">æ¸…æƒæ–™é‡‘</span>
                <span class="text-gray-900">Â¥{{ cleaningFee.toLocaleString() }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">ç¨é‡‘</span>
                <span class="text-gray-900">Â¥{{ taxAmount.toLocaleString() }}</span>
              </div>
            </div>

            <!-- åˆè¨ˆ -->
            <div class="pt-4 border-t border-gray-200">
              <div class="flex justify-between items-center">
                <span class="font-semibold text-gray-900">åˆè¨ˆé¡ JPY</span>
                <span class="font-semibold text-gray-900 text-xl">Â¥{{ totalAmount.toLocaleString() }}</span>
              </div>
              <button type="button" class="text-sm underline text-gray-600 hover:text-gray-900 mt-2">
                æ–™é‡‘å†…è¨³
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <AppFooter />

    <!-- æ±ºæ¸ˆå‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div v-if="showConfirmation" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">äºˆç´„å†…å®¹ã®æœ€çµ‚ç¢ºèª</h3>

        <div class="space-y-3 mb-6">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</span>
            <span class="font-medium text-gray-900">{{ formatDisplayDate(checkInDate) }} 15:00ä»¥é™</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span>
            <span class="font-medium text-gray-900">{{ formatDisplayDate(checkOutDate) }} 11:00ã¾ã§</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">å®¿æ³Šäººæ•°</span>
            <span class="font-medium text-gray-900">å¤§äºº{{ adults }}åã€å­ã©ã‚‚{{ children }}å</span>
          </div>
          <div class="border-t pt-3 flex justify-between">
            <span class="font-semibold text-gray-900">åˆè¨ˆé‡‘é¡</span>
            <span class="font-semibold text-lg text-gray-900">Â¥{{ totalAmount.toLocaleString() }}</span>
          </div>
        </div>

        <div class="flex gap-3">
          <button
            @click="showConfirmation = false"
            class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors"
          >
            ä¿®æ­£ã™ã‚‹
          </button>
          <button
            @click="proceedToPayment"
            class="flex-1 px-6 py-3 text-white font-medium rounded-lg transition-all hover:opacity-90"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
          >
            æ±ºæ¸ˆã¸é€²ã‚€
          </button>
        </div>
      </div>
    </div>

    <!-- æ±ºæ¸ˆå‡¦ç†ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div v-if="isProcessing" class="fixed inset-0 bg-white/95 flex items-center justify-center z-50">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-purple-200 border-t-purple-600 mx-auto mb-4"></div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">æ±ºæ¸ˆå‡¦ç†ä¸­...</h3>
        <p class="text-sm text-gray-600 mb-1">ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç¢ºèªã—ã¦ã„ã¾ã™</p>
        <p class="text-xs text-gray-500">ã“ã®ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ï¼ˆæœ€å¤§30ç§’ï¼‰</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
definePageMeta({
  layout: false
})

const route = useRoute()
const router = useRouter()
const { createBooking } = useBookings()
const { createPaymentIntent, initializeElements, confirmCardPayment } = useStripePayment()

// ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰äºˆç´„æƒ…å ±ã‚’å–å¾—
const checkInDate = ref(route.query.checkIn as string || '')
const checkOutDate = ref(route.query.checkOut as string || '')
const adults = ref(parseInt(route.query.adults as string) || 1)
const children = ref(parseInt(route.query.children as string) || 0)

// æ–™é‡‘è¨­å®š
const pricePerNight = 16782
const cleaningFee = 0
const taxRate = 0.123 // 12.3%

// è¨ˆç®—
const numberOfNights = computed(() => {
  if (!checkInDate.value || !checkOutDate.value) return 0
  const start = new Date(checkInDate.value)
  const end = new Date(checkOutDate.value)
  return Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24))
})

const subtotal = computed(() => pricePerNight * numberOfNights.value)
const taxAmount = computed(() => Math.round(subtotal.value * taxRate))
const totalAmount = computed(() => subtotal.value + cleaningFee + taxAmount.value)

// ã‚²ã‚¹ãƒˆæƒ…å ±
const guestName = ref('')
const guestEmail = ref('')
const guestPhone = ref('')

// æ”¯æ‰•ã„é–¢é€£ï¼ˆStripeï¼‰
const paymentReady = ref(false)
const clientSecret = ref('')
let cardElement: any = null

// åŒæ„
const agreedToTerms = ref(false)
const isSubmitting = ref(false)

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
const showConfirmation = ref(false)
const isProcessing = ref(false)

const cancellationDeadline = computed(() => {
  if (!checkInDate.value) return ''
  const date = new Date(checkInDate.value)
  date.setDate(date.getDate() - 5) // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³5æ—¥å‰
  return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
})

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
const formatDisplayDate = (dateStr: string): string => {
  if (!dateStr) return ''
  const date = new Date(dateStr)
  return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
}

// åˆæœŸåŒ–å‡¦ç†
onMounted(async () => {
  try {
    // Payment Intentã‚’ä½œæˆ
    const guestCount = adults.value + children.value

    const result = await createPaymentIntent(
      checkInDate.value,
      checkOutDate.value,
      guestCount
    )

    console.log('ğŸ“¦ Payment Intentä½œæˆçµæœ:', result)

    if (!result || !result.clientSecret) {
      console.error('âŒ clientSecretãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ:', result)
      throw new Error('æ±ºæ¸ˆã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ')
    }

    clientSecret.value = result.clientSecret
    console.log('âœ… clientSecretå–å¾—æˆåŠŸ:', result.clientSecret.substring(0, 30) + '...')

    // Stripe Elementsã‚’åˆæœŸåŒ–
    const elements = await initializeElements(result.clientSecret)

    // paymentReadyã‚’trueã«ã—ã¦DOMã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    paymentReady.value = true

    // DOMã®æº–å‚™ã‚’å¾…ã£ã¦ã‹ã‚‰ãƒã‚¦ãƒ³ãƒˆ
    await nextTick()

    // Card Elementã‚’ä½œæˆã—ã¦ãƒã‚¦ãƒ³ãƒˆ
    const cardElementContainer = document.getElementById('card-element')
    if (!cardElementContainer) {
      throw new Error('æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
    }

    // Card Elementã‚’ä½œæˆï¼ˆã‚¹ã‚¿ã‚¤ãƒ«ä»˜ãã€éƒµä¾¿ç•ªå·éè¡¨ç¤ºï¼‰
    cardElement = elements.create('card', {
      hidePostalCode: true, // éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
      style: {
        base: {
          fontSize: '16px',
          color: '#30313d',
          fontFamily: 'system-ui, sans-serif',
          '::placeholder': {
            color: '#9ca3af'
          }
        },
        invalid: {
          color: '#df1b41'
        }
      }
    })

    console.log('ğŸ¨ Card Elementä½œæˆå®Œäº†ã€ãƒã‚¦ãƒ³ãƒˆé–‹å§‹...')
    cardElement.mount('#card-element')
    console.log('âœ… Card Elementãƒã‚¦ãƒ³ãƒˆå®Œäº†')
  } catch (error: any) {
    console.error('StripeåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error)
    alert('æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚')
  }
})

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
const isFormValid = computed(() => {
  // ã‚²ã‚¹ãƒˆæƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
  if (!guestName.value.trim() || !guestEmail.value.trim() || !guestPhone.value.trim()) {
    return false
  }

  // æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™å®Œäº†ãƒã‚§ãƒƒã‚¯
  if (!paymentReady.value) {
    return false
  }

  // åŒæ„ã®ãƒã‚§ãƒƒã‚¯
  if (!agreedToTerms.value) return false

  return true
})

// é€ä¿¡å‡¦ç†ï¼ˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼‰
const handleSubmit = async () => {
  if (!isFormValid.value) {
    alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„')
    return
  }

  // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  showConfirmation.value = true
}

// æ±ºæ¸ˆå‡¦ç†ã®å®Ÿè¡Œ
const proceedToPayment = async () => {
  showConfirmation.value = false
  isProcessing.value = true
  isSubmitting.value = true

  try {
    // Payment Intentã®metadataã‚’æ›´æ–°ï¼ˆæœ€æ–°ã®ã‚²ã‚¹ãƒˆæƒ…å ±ã‚’å«ã‚ã‚‹ï¼‰
    const config = useRuntimeConfig()
    const { csrf } = useCsrf()

    await $fetch('/api/stripe/update-payment-intent', {
      method: 'POST',
      headers: {
        'csrf-token': csrf || ''
      },
      body: {
        paymentIntentId: clientSecret.value.split('_secret_')[0],
        metadata: {
          guestName: guestName.value,
          guestEmail: guestEmail.value,
          guestPhone: guestPhone.value,
          checkIn: checkInDate.value,
          checkOut: checkOutDate.value,
          guests: `å¤§äºº${adults.value}äººã€ä¹³å¹¼å…${children.value}äºº`,
          totalAmount: totalAmount.value.toString()
        }
      }
    })

    // äºˆç´„ã‚’Firestoreã«ä¿å­˜
    const bookingData = {
      type: 'stay' as const,
      startDate: new Date(checkInDate.value),
      endDate: new Date(checkOutDate.value),
      guestCount: adults.value + children.value,
      guestName: guestName.value,
      guestEmail: guestEmail.value,
      guestPhone: guestPhone.value,
      totalAmount: totalAmount.value,
      baseAmount: subtotal.value,
      discountAmount: 0,
      notes: `æ±ºæ¸ˆID: ${clientSecret.value.split('_secret_')[0]}`
    }

    const bookingId = await createBooking(bookingData)
    console.log('âœ… äºˆç´„ä½œæˆæˆåŠŸ:', bookingId)

    // Stripeæ±ºæ¸ˆã‚’ç¢ºå®šï¼ˆCard Elementç”¨ï¼‰
    // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼ˆHTTPï¼‰ã§ã¯Stripeæ±ºæ¸ˆãŒåˆ¶é™ã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯æ±ºæ¸ˆã‚’ã‚¹ã‚­ãƒƒãƒ—
    const isLocalDev = window.location.hostname === 'localhost'

    if (isLocalDev) {
      // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º: æ±ºæ¸ˆã‚¹ã‚­ãƒƒãƒ—ã—ã¦å®Œäº†ãƒšãƒ¼ã‚¸ã¸
      console.log('ğŸ”§ ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ: æ±ºæ¸ˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™')
      const paymentIntentId = clientSecret.value.split('_secret_')[0]
      router.push({
        path: '/booking/complete',
        query: {
          payment_intent: paymentIntentId,
          booking_id: bookingId,
          email: guestEmail.value
        }
      })
    } else {
      // æœ¬ç•ªç’°å¢ƒ: å®Ÿéš›ã«æ±ºæ¸ˆã‚’å®Ÿè¡Œ
      const paymentIntent = await confirmCardPayment(clientSecret.value, cardElement)

      // æ±ºæ¸ˆæˆåŠŸå¾Œã€å®Œäº†ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      if (paymentIntent && paymentIntent.status === 'succeeded') {
        router.push({
          path: '/booking/complete',
          query: {
            payment_intent: paymentIntent.id,
            booking_id: bookingId,
            email: guestEmail.value
          }
        })
      }
    }
  } catch (error: any) {
    console.error('äºˆç´„ãƒ»æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼:', error)
    alert(error.message || 'äºˆç´„ãƒ»æ±ºæ¸ˆã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ')
    isProcessing.value = false
    isSubmitting.value = false
  }
}

// SEOè¨­å®š
useHead({
  title: 'äºˆç´„ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | å®¶å…·ã®å®¶ No.1',
  meta: [
    { name: 'robots', content: 'noindex' }
  ]
})
</script>

<style scoped>
input:focus {
  outline: none;
}
</style>
